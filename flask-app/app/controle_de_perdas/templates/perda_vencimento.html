{% extends "base.html" %}

{% block title %}Perdas por Vencimento - Controle de Perdas{% endblock %}

{% block content %}
<article class="perda-vencimento-page" role="main" aria-labelledby="page-title">
    <section class="perda-vencimento-summary" aria-label="Resumo geral">
        <div class="perda-vencimento-table-container">
            <header class="perda-vencimento-header">
                <div class="header-content">
                    <div class="header-title">
                        <h2 id="page-title">üìÖ Perdas por Vencimento</h2>
                    </div>
                    
                    <div class="summary-container">
                        <div class="summary-card total-vencimento">
                            <div class="summary-content">
                                <h3>Total de Perdas</h3>
                                <p class="summary-value">{{ vencimento_vlr_total }}</p>
                            </div>
                        </div>
                        
                        <div class="summary-card produtos-vencidos">
                            <div class="summary-content">
                                <h3>Total EMB1</h3>
                                <p class="summary-value">{{ vencimento_emb1_total if vencimento_emb1_total else '0' }}</p>
                            </div>
                        </div>
                    </div>
                </div>
            </header>
        </div>
    </section>



    <section class="perda-vencimento-table" aria-label="Tabela detalhada de perdas por vencimento">
        <div class="table-container">

            
            <div class="table-wrapper">
                {% if vencimento_data %}
                    <table class="vencimento-table" id="vencimento-table">
                        <thead>
                            <tr>
                                <th class="sortable" data-column="mercadoria">Mercadoria</th>
                                <th class="sortable" data-column="descricao">Descri√ß√£o</th>
                                <th class="sortable" data-column="valor">Valor Total</th>
                                <th class="sortable" data-column="emb1">EMB1</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in vencimento_data %}
                            <tr class="vencimento-row" data-valor="{{ item['VLR.TOTAL'] if item['VLR.TOTAL'] else '0' }}">
                                <td class="mercadoria">{{ item.MERCADORIA }}</td>
                                <td class="descricao" title="{{ item.DESCRICAO }}">{{ item.DESCRICAO }}</td>
                                <td class="valor">{{ item['VLR.TOTAL'] }}</td>
                                <td class="emb1">{{ item.EMB1 }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                {% else %}
                    <div class="no-data">
                        <div class="no-data-icon">üìÖ</div>
                        <p>Nenhuma perda por vencimento encontrada</p>
                        <small>Verifique os filtros aplicados ou tente atualizar os dados</small>
                    </div>
                {% endif %}
            </div>
            

        </div>
    </section>


</article>

<style>
/* Vari√°veis de cores baseadas na paleta cores.css */
:root {
    --primary-green: #33A621;    /* Verde principal */
    --accent-orange: #D9961A;    /* Laranja de destaque */
    --light-beige: #F2EFEB;      /* Bege claro */
    --dark-brown: #BF4417;       /* Marrom escuro */
    --white: #ffffff;
    --light-gray: #f8f9fa;
    --medium-gray: #6c757d;
    --dark-gray: #333333;
    --border-color: #e0e0e0;
}

.perda-vencimento-header {
    margin: 0 0 6px;
    margin-top: 0 !important;
    padding: 0.3rem;
    background: linear-gradient(135deg, var(--primary-green), #2a8f1a);
    border-radius: 5px;
    box-shadow: 0 4px 15px rgba(51, 166, 33, 0.2);
    color: var(--white);
}

.header-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 20px;
}

.header-title {
    flex-shrink: 0;
}

.perda-vencimento-header h2 {
    margin: 0;
    color: var(--white);
    font-size: 1.1rem;
    font-weight: 600;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.perda-vencimento-page {
    max-width: 1400px;
    margin: 0 auto;
    padding: 12px;
    position: relative;
    z-index: 100;
    padding-top: 0 !important;
}

.summary-container {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    justify-content: flex-end;
    margin-bottom: 0;
}

.summary-card {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 6px;
    padding: 2px 4px;
    text-align: center;
    border: 1px solid rgba(255, 255, 255, 0.2);
}

.summary-card.total-vencimento {
    background: linear-gradient(135deg, #e67e22, #d35400);
    border: 1px solid #d68910;
}

.summary-card.produtos-vencidos {
    background: linear-gradient(135deg, #e74c3c, #c0392b);
    border: 1px solid #b03a2e;
}



.summary-content h3 {
    color: #ffffff;
    margin-bottom: 2px;
    font-size: 0.7rem;
    font-weight: 500;
}

.summary-value {
    font-size: 0.9rem;
    font-weight: bold;
    color: #ffffff;
    margin: 0;
    line-height: 1.1;
}

.summary-label {
    color: rgba(255, 255, 255, 0.9);
    font-size: 0.5rem;
    margin-top: 0px;
}



.table-container {
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    overflow: hidden;
    margin-bottom: 6px;
    max-height: 75vh;
}

.table-header {
    background: #f8f9fa;
    padding: 8px 12px;
    border-bottom: 1px solid #dee2e6;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 8px;
}

.table-header h3 {
    color: #2c3e50;
    margin: 0;
    font-size: 1rem;
    font-weight: 600;
}

.table-actions {
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
}

.action-button {
    padding: 4px 8px;
    border: none;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s;
    background: #3498db;
    color: white;
}

.action-button:hover {
    background: #2980b9;
}

.table-wrapper {
    max-height: calc(75vh - 80px);
    overflow-y: auto;
    margin: 0;
    padding: 0;
}

.vencimento-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.75rem;
    table-layout: fixed;
    border: none;
}

.vencimento-table th {
    background: #f8f9fa;
    color: #2c3e50;
    padding: 4px 6px;
    text-align: left;
    border-bottom: 2px solid #dee2e6;
    border-left: none;
    border-right: none;
    font-weight: 600;
    font-size: 0.65rem;
    white-space: nowrap;
    position: sticky;
    top: 0;
    z-index: 10;
    cursor: pointer;
    user-select: none;
}

.vencimento-table th.sortable:hover {
    background: #e9ecef;
}

.vencimento-table th.sortable::after {
    content: ' ‚ÜïÔ∏è';
    font-size: 0.6rem;
    opacity: 0.5;
}

/* Configura√ß√£o espec√≠fica das colunas com larguras fixas */
.vencimento-table th:nth-child(1) { width: 80px; } /* Mercadoria */
.vencimento-table th:nth-child(2) { width: 180px; } /* Descri√ß√£o */
.vencimento-table th:nth-child(3) { width: 90px; text-align: right; } /* Valor Total */
.vencimento-table th:nth-child(4) { width: 50px; text-align: center; } /* EMB1 */

.vencimento-table td {
    padding: 3px 6px;
    border-bottom: 1px solid #dee2e6;
    border-left: none;
    border-right: none;
    vertical-align: top;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

/* Configura√ß√£o espec√≠fica das c√©lulas */
.vencimento-table td:nth-child(1) { 
    width: 80px;
}

.vencimento-table td:nth-child(2) { 
    width: 180px;
}

.vencimento-table td:nth-child(3) { 
    text-align: right;
    width: 90px;
}

.vencimento-table td:nth-child(4) { 
    text-align: center;
    width: 50px;
}

.vencimento-table tr:hover {
    background-color: #f8f9fa;
}

/* Remover bordas externas */
.vencimento-table th:first-child,
.vencimento-table td:first-child {
    border-left: none;
}

.vencimento-table th:last-child,
.vencimento-table td:last-child {
    border-right: none;
}

.vencimento-table tr:first-child th {
    border-top: none;
}

.vencimento-row.vencido {
    background-color: rgba(231, 76, 60, 0.05);
}

.vencimento-row.proximo {
    background-color: rgba(241, 196, 15, 0.05);
}

.vencimento-row.valido {
    background-color: rgba(39, 174, 96, 0.05);
}

.evento-code {
    background: #e8f4fd;
    color: #3498db;
    padding: 2px 4px;
    border-radius: 3px;
    font-weight: bold;
    text-align: center;
    font-size: 0.7rem;
    font-family: 'Courier New', monospace;
}

.mercadoria {
    font-weight: 500;
    color: #2c3e50;
    font-size: 0.7rem;
}

.descricao {
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    font-size: 0.7rem;
    line-height: 1.2;
    width: 180px;
}

.valor {
    font-weight: bold;
    color: #e74c3c;
    text-align: right;
    font-size: 0.85rem;
}

.emb1 {
    text-align: center;
    font-weight: 500;
    font-size: 0.7rem;
    color: #3498db;
}

.data, .vencimento {
    color: #7f8c8d;
    font-size: 0.65rem;
    font-family: 'Courier New', monospace;
}

.status-badge {
    padding: 2px 4px;
    border-radius: 8px;
    font-size: 0.6rem;
    font-weight: 500;
    text-transform: uppercase;
    text-align: center;
    display: inline-block;
    min-width: 40px;
}

.status-badge.vencido {
    background: #e74c3c;
    color: white;
}

.status-badge.proximo {
    background: #f39c12;
    color: white;
}

.status-badge.valido {
    background: #27ae60;
    color: white;
}

.dias-badge {
    padding: 1px 3px;
    border-radius: 4px;
    font-weight: bold;
    text-align: center;
    font-size: 0.6rem;
    display: inline-block;
    min-width: 20px;
}

.dias-badge.negative {
    background: #e74c3c;
    color: white;
}

.dias-badge.warning {
    background: #f39c12;
    color: white;
}

.dias-badge.positive {
    background: #27ae60;
    color: white;
}

.table-footer {
    background: #f8f9fa;
    padding: 15px 20px;
    border-top: 1px solid #dee2e6;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 15px;
}

.pagination-info {
    color: #7f8c8d;
    font-size: 0.9rem;
}

.table-totals {
    display: flex;
    gap: 15px;
    align-items: center;
}

.total-label {
    color: #2c3e50;
    font-weight: 500;
}

.total-value {
    font-size: 1.2rem;
    font-weight: bold;
    color: #e74c3c;
}

.total-units {
    color: #7f8c8d;
    font-size: 0.9rem;
}

.no-data {
    text-align: center;
    color: #7f8c8d;
    padding: 80px 20px;
}

.no-data-icon {
    font-size: 5rem;
    margin-bottom: 20px;
    opacity: 0.5;
}

.no-data p {
    font-size: 1.2rem;
    margin-bottom: 10px;
}

.no-data small {
    font-size: 0.9rem;
    opacity: 0.8;
}



@media (max-width: 768px) {
    .header-content {
        flex-direction: column;
        gap: 15px;
        align-items: stretch;
    }
    
    .summary-container {
        justify-content: center;
    }
    
    .header-title {
        text-align: center;
    }
    
    .perda-vencimento-header {
        padding: 6px;
    }
    
    .perda-vencimento-header h2 {
        font-size: 1.2rem;
    }
    
    .summary-card {
        padding: 6px 8px;
    }
    
    .summary-value {
        font-size: 0.8rem;
    }
    
    .summary-label {
        font-size: 0.55rem;
    }
    

    
    .table-header {
        flex-direction: column;
        align-items: stretch;
        padding: 6px;
    }
    
    .table-actions {
        justify-content: center;
    }
    
    .table-footer {
        flex-direction: column;
        align-items: stretch;
        text-align: center;
        padding: 8px;
    }
    
    .vencimento-table {
        font-size: 0.65rem;
    }
    
    .vencimento-table th,
    .vencimento-table td {
        padding: 2px 3px;
    }
    
    .descricao {
        max-width: 120px;
    }
    

}

@media (max-width: 480px) {
    .perda-vencimento-header {
        padding: 4px;
    }
    
    .perda-vencimento-header h2 {
        font-size: 1rem;
    }
    
    .summary-card {
        padding: 4px 6px;
    }
    
    .summary-value {
        font-size: 0.7rem;
    }
    
    .summary-label {
        font-size: 0.5rem;
    }
    
    .vencimento-table {
        font-size: 0.6rem;
    }
    
    .vencimento-table th,
    .vencimento-table td {
        padding: 1px 2px;
    }
    
    .descricao {
        max-width: 100px;
    }
    
    .timeline-item {
        padding: 3px 2px;
    }
    
    .timeline-label {
        font-size: 0.6rem;
    }
    
    .timeline-value {
        font-size: 0.7rem;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Funcionalidade de ordena√ß√£o
    const table = document.getElementById('vencimento-table');
    if (table) {
        const headers = table.querySelectorAll('th.sortable');
        headers.forEach((header, index) => {
            header.addEventListener('click', () => sortTable(table, index));
        });
    }
    

    
    // Bot√µes de a√ß√£o
    const exportExcelBtn = document.getElementById('export-excel');
    const exportPdfBtn = document.getElementById('export-pdf');
    const refreshDataBtn = document.getElementById('refresh-data');
    
    if (exportExcelBtn) {
        exportExcelBtn.addEventListener('click', exportToExcel);
    }
    
    if (exportPdfBtn) {
        exportPdfBtn.addEventListener('click', exportToPdf);
    }
    
    if (refreshDataBtn) {
        refreshDataBtn.addEventListener('click', refreshData);
    }
    
    // Animar barras de progresso
    const bars = document.querySelectorAll('.bar-fill');
    bars.forEach(bar => {
        const width = bar.style.width;
        bar.style.width = '0%';
        setTimeout(() => {
            bar.style.width = width;
        }, 500);
    });
});

function sortTable(table, column) {
    const tbody = table.querySelector('tbody');
    const rows = Array.from(tbody.querySelectorAll('tr'));
    
    const sortedRows = rows.sort((a, b) => {
        const aText = a.cells[column].textContent.trim();
        const bText = b.cells[column].textContent.trim();
        
        // Tentar converter para n√∫mero se poss√≠vel
        const aNum = parseFloat(aText.replace(/[^\d.-]/g, ''));
        const bNum = parseFloat(bText.replace(/[^\d.-]/g, ''));
        
        if (!isNaN(aNum) && !isNaN(bNum)) {
            return aNum - bNum;
        }
        
        return aText.localeCompare(bText);
    });
    
    // Limpar tbody e adicionar linhas ordenadas
    tbody.innerHTML = '';
    sortedRows.forEach(row => tbody.appendChild(row));
    
    updateTableTotals();
}



function updateTableTotals() {
    const visibleRows = document.querySelectorAll('.vencimento-row:not([style*="display: none"])');
    let totalValue = 0;
    let totalUnits = 0;
    
    visibleRows.forEach(row => {
        const valor = parseFloat(row.dataset.valor.replace(/[^\d.-]/g, '')) || 0;
        const units = parseInt(row.querySelector('.emb1').textContent) || 0;
        
        totalValue += valor;
        totalUnits += units;
    });
    
    document.getElementById('total-value').textContent = totalValue.toLocaleString('pt-BR', {
        style: 'currency',
        currency: 'BRL'
    });
    document.getElementById('total-units').textContent = `${totalUnits} unidades`;
}

function exportToExcel() {
    // Implementar exporta√ß√£o para Excel
    alert('Funcionalidade de exporta√ß√£o para Excel ser√° implementada');
}

function exportToPdf() {
    // Implementar exporta√ß√£o para PDF
    alert('Funcionalidade de exporta√ß√£o para PDF ser√° implementada');
}

function refreshData() {
    // Implementar atualiza√ß√£o de dados
    location.reload();
}

// Fun√ß√£o para destacar linhas por status
function highlightStatus(status) {
    const rows = document.querySelectorAll(`.vencimento-row[data-status="${status}"]`);
    rows.forEach(row => {
        row.style.backgroundColor = '#fff3cd';
        setTimeout(() => {
            row.style.backgroundColor = '';
        }, 2000);
    });
}
</script>
{% endblock %}