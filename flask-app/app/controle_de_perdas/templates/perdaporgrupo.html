{% extends "base.html" %}

{% block title %}Perdas por Grupo - Controle de Perdas{% endblock %}

{% block content %}
<article class="perdaporgrupo-page" role="main" aria-labelledby="page-title">
    <section class="perdaporgrupo-header" aria-label="Cabe√ßalho das perdas por grupo">
        <div class="header-container">
            <header class="page-title">
                <h2 id="page-title">üìä Perdas por Grupo</h2>
                <p class="page-subtitle">An√°lise detalhada das perdas organizadas por grupos de produtos</p>
            </header>
            
            <nav class="breadcrumb-nav">
                <a href="{{ url_for('controle_de_perdas.index') }}" class="breadcrumb-link">üè† In√≠cio</a>
                <span class="breadcrumb-separator">></span>
                <a href="{{ url_for('controle_de_perdas.menu') }}" class="breadcrumb-link">üìã Menu</a>
                <span class="breadcrumb-separator">></span>
                <span class="breadcrumb-current">üìä Perdas por Grupo</span>
            </nav>
        </div>
    </section>

    <section class="perdaporgrupo-summary" aria-label="Resumo geral das perdas por grupo">
        <div class="summary-container">
            <div class="summary-card total-grupos">
                <div class="summary-icon">üìä</div>
                <div class="summary-content">
                    <h3>Total de Grupos</h3>
                    <p class="summary-value">{{ total_grupos if total_grupos else '0' }}</p>
                    <span class="summary-label">Grupos analisados</span>
                </div>
            </div>
            
            <div class="summary-card valor-total">
                <div class="summary-icon">üí∞</div>
                <div class="summary-content">
                    <h3>Valor Total</h3>
                    <p class="summary-value">{{ valor_total_grupos if valor_total_grupos else '0,00' }}</p>
                    <span class="summary-label">Soma de todos os grupos</span>
                </div>
            </div>
            
            <div class="summary-card grupo-maior">
                <div class="summary-icon">üìà</div>
                <div class="summary-content">
                    <h3>Maior Perda</h3>
                    <p class="summary-value">{{ grupo_maior_perda.nome if grupo_maior_perda else 'N/A' }}</p>
                    <span class="summary-label">{{ grupo_maior_perda.valor if grupo_maior_perda else '0,00' }}</span>
                </div>
            </div>
            
            <div class="summary-card periodo-analise">
                <div class="summary-icon">üìÖ</div>
                <div class="summary-content">
                    <h3>Per√≠odo</h3>
                    <p class="summary-value">{{ periodo_analise if periodo_analise else 'Hoje' }}</p>
                    <span class="summary-label">Data de refer√™ncia</span>
                </div>
            </div>
        </div>
    </section>

    <section class="perdaporgrupo-filters" aria-label="Filtros de an√°lise por grupo">
        <div class="filters-container">
            <div class="filter-group">
                <label for="filter-grupo">Filtrar por Grupo:</label>
                <select id="filter-grupo" class="filter-select">
                    <option value="all">Todos os Grupos</option>
                    {% if grupos_disponiveis %}
                        {% for grupo in grupos_disponiveis %}
                        <option value="{{ grupo.codigo }}">{{ grupo.nome }}</option>
                        {% endfor %}
                    {% endif %}
                </select>
            </div>
            
            <div class="filter-group">
                <label for="filter-valor-min">Valor M√≠nimo:</label>
                <input type="number" id="filter-valor-min" class="filter-input" placeholder="0,00" step="0.01">
            </div>
            
            <div class="filter-group">
                <label for="filter-valor-max">Valor M√°ximo:</label>
                <input type="number" id="filter-valor-max" class="filter-input" placeholder="999999,99" step="0.01">
            </div>
            
            <div class="filter-group">
                <label for="filter-ordenacao">Ordenar por:</label>
                <select id="filter-ordenacao" class="filter-select">
                    <option value="valor-desc">Maior Valor</option>
                    <option value="valor-asc">Menor Valor</option>
                    <option value="nome-asc">Nome A-Z</option>
                    <option value="nome-desc">Nome Z-A</option>
                    <option value="quantidade-desc">Maior Quantidade</option>
                </select>
            </div>
            
            <button id="apply-filters" class="filter-button">üîç Aplicar Filtros</button>
            <button id="clear-filters" class="filter-button secondary">üóëÔ∏è Limpar</button>
            <button id="export-groups" class="filter-button success">üìä Exportar</button>
        </div>
    </section>

    <section class="perdaporgrupo-grid" aria-label="Grid de an√°lise por grupos">
        <div class="grid-container" id="grupos-grid">
            {% if grupos_data %}
                {% for grupo in grupos_data %}
                <div class="grupo-box" data-grupo="{{ grupo.codigo }}" data-valor="{{ grupo.valor_total }}" data-nome="{{ grupo.nome }}">
                    <div class="grupo-header">
                        <div class="grupo-title">
                            <h3>{{ grupo.nome }}</h3>
                            <span class="grupo-codigo">{{ grupo.codigo }}</span>
                        </div>
                        <div class="grupo-actions">
                            <button class="grupo-btn expand" onclick="toggleGrupo('{{ grupo.codigo }}')" title="Expandir/Recolher">
                                üìã
                            </button>
                            <button class="grupo-btn details" onclick="showGrupoDetails('{{ grupo.codigo }}')" title="Detalhes">
                                üëÅÔ∏è
                            </button>
                            <button class="grupo-btn export" onclick="exportGrupo('{{ grupo.codigo }}')" title="Exportar">
                                üìä
                            </button>
                        </div>
                    </div>
                    
                    <div class="grupo-summary">
                        <div class="summary-stats">
                            <div class="stat-item">
                                <span class="stat-label">Valor Total:</span>
                                <span class="stat-value">{{ grupo.valor_total }}</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Quantidade:</span>
                                <span class="stat-value">{{ grupo.quantidade_total }}</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Itens:</span>
                                <span class="stat-value">{{ grupo.itens_count }}</span>
                            </div>
                        </div>
                        
                        <div class="grupo-chart">
                            <div class="chart-bar">
                                <div class="bar-fill" style="width: {{ grupo.percentage }}%"></div>
                                <span class="bar-percentage">{{ grupo.percentage }}%</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="grupo-content" id="content-{{ grupo.codigo }}" style="display: none;">
                        <div class="content-tabs">
                            <button class="tab-btn active" onclick="showTab('{{ grupo.codigo }}', 'eventos')">üìä Eventos</button>
                            <button class="tab-btn" onclick="showTab('{{ grupo.codigo }}', 'produtos')">üì¶ Produtos</button>
                            <button class="tab-btn" onclick="showTab('{{ grupo.codigo }}', 'timeline')">üìà Timeline</button>
                        </div>
                        
                        <!-- Tab Eventos -->
                        <div class="tab-content" id="tab-eventos-{{ grupo.codigo }}">
                            <div class="eventos-grid">
                                {% if grupo.eventos %}
                                    {% for evento in grupo.eventos %}
                                    <div class="evento-item">
                                        <div class="evento-header">
                                            <span class="evento-code">{{ evento.codigo }}</span>
                                            <span class="evento-count">{{ evento.count }} ocorr√™ncias</span>
                                        </div>
                                        <div class="evento-body">
                                            <div class="evento-valor">{{ evento.valor }}</div>
                                            <div class="evento-descricao">{{ evento.descricao }}</div>
                                        </div>
                                        <div class="evento-actions">
                                            <button class="evento-btn" onclick="analyzeEvento('{{ grupo.codigo }}', '{{ evento.codigo }}')">
                                                üîç Analisar
                                            </button>
                                        </div>
                                    </div>
                                    {% endfor %}
                                {% else %}
                                    <div class="no-data">
                                        <p>Nenhum evento encontrado para este grupo</p>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Tab Produtos -->
                        <div class="tab-content" id="tab-produtos-{{ grupo.codigo }}" style="display: none;">
                            <div class="produtos-table">
                                {% if grupo.produtos %}
                                    <table class="produtos-table-content">
                                        <thead>
                                            <tr>
                                                <th>Mercadoria</th>
                                                <th>Descri√ß√£o</th>
                                                <th>Valor</th>
                                                <th>Quantidade</th>
                                                <th>A√ß√µes</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for produto in grupo.produtos %}
                                            <tr>
                                                <td class="mercadoria">{{ produto.mercadoria }}</td>
                                                <td class="descricao" title="{{ produto.descricao }}">{{ produto.descricao }}</td>
                                                <td class="valor">{{ produto.valor }}</td>
                                                <td class="quantidade">{{ produto.quantidade }}</td>
                                                <td class="actions">
                                                    <button class="action-btn" onclick="analyzeProduto('{{ grupo.codigo }}', '{{ produto.mercadoria }}')">
                                                        üîç
                                                    </button>
                                                    <button class="action-btn" onclick="adjustProduto('{{ grupo.codigo }}', '{{ produto.mercadoria }}')">
                                                        ‚öôÔ∏è
                                                    </button>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                {% else %}
                                    <div class="no-data">
                                        <p>Nenhum produto encontrado para este grupo</p>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Tab Timeline -->
                        <div class="tab-content" id="tab-timeline-{{ grupo.codigo }}" style="display: none;">
                            <div class="timeline-container">
                                {% if grupo.timeline %}
                                    {% for item in grupo.timeline %}
                                    <div class="timeline-item">
                                        <div class="timeline-marker"></div>
                                        <div class="timeline-content">
                                            <div class="timeline-date">{{ item.data }}</div>
                                            <div class="timeline-event">{{ item.evento }}</div>
                                            <div class="timeline-value">{{ item.valor }}</div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                {% else %}
                                    <div class="no-data">
                                        <p>Nenhum hist√≥rico dispon√≠vel para este grupo</p>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="no-groups">
                    <div class="no-groups-icon">üìä</div>
                    <h3>Nenhum grupo encontrado</h3>
                    <p>N√£o h√° dados de perdas por grupo para exibir</p>
                    <button class="refresh-btn" onclick="location.reload()">üîÑ Atualizar Dados</button>
                </div>
            {% endif %}
        </div>
    </section>

    <section class="perdaporgrupo-analytics" aria-label="An√°lise estat√≠stica dos grupos">
        <div class="analytics-container">
            <div class="analytics-card ranking-grupos">
                <div class="card-header">
                    <h3>üèÜ Ranking de Grupos</h3>
                    <div class="card-actions">
                        <button class="card-btn" onclick="refreshRanking()">üîÑ</button>
                        <button class="card-btn" onclick="exportRanking()">üìä</button>
                    </div>
                </div>
                <div class="card-content">
                    {% if ranking_grupos %}
                        <div class="ranking-list">
                            {% for item in ranking_grupos %}
                            <div class="ranking-item">
                                <div class="ranking-position">{{ loop.index }}</div>
                                <div class="ranking-info">
                                    <div class="ranking-name">{{ item.nome }}</div>
                                    <div class="ranking-details">{{ item.itens }} itens ‚Ä¢ {{ item.eventos }} eventos</div>
                                </div>
                                <div class="ranking-value">{{ item.valor }}</div>
                                <div class="ranking-percentage">{{ item.percentage }}%</div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="no-data">
                            <p>Dados de ranking n√£o dispon√≠veis</p>
                        </div>
                    {% endif %}
                </div>
            </div>
            
            <div class="analytics-card distribuicao-valores">
                <div class="card-header">
                    <h3>üìà Distribui√ß√£o de Valores</h3>
                    <div class="card-actions">
                        <button class="card-btn" onclick="refreshDistribuicao()">üîÑ</button>
                        <button class="card-btn" onclick="exportDistribuicao()">üìä</button>
                    </div>
                </div>
                <div class="card-content">
                    <div class="distribuicao-chart">
                        {% if distribuicao_valores %}
                            {% for faixa in distribuicao_valores %}
                            <div class="distribuicao-item">
                                <div class="distribuicao-label">{{ faixa.label }}</div>
                                <div class="distribuicao-bar">
                                    <div class="bar-fill" style="width: {{ faixa.percentage }}%"></div>
                                    <span class="bar-value">{{ faixa.count }}</span>
                                </div>
                                <div class="distribuicao-percentage">{{ faixa.percentage }}%</div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="no-data">
                                <p>Dados de distribui√ß√£o n√£o dispon√≠veis</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <div class="analytics-card comparativo-mensal">
                <div class="card-header">
                    <h3>üìä Comparativo Mensal</h3>
                    <div class="card-actions">
                        <button class="card-btn" onclick="refreshComparativo()">üîÑ</button>
                        <button class="card-btn" onclick="exportComparativo()">üìä</button>
                    </div>
                </div>
                <div class="card-content">
                    <div class="comparativo-chart">
                        {% if comparativo_mensal %}
                            {% for mes in comparativo_mensal %}
                            <div class="comparativo-item">
                                <div class="comparativo-mes">{{ mes.nome }}</div>
                                <div class="comparativo-valores">
                                    <div class="valor-atual">{{ mes.atual }}</div>
                                    <div class="valor-anterior">{{ mes.anterior }}</div>
                                    <div class="valor-variacao {{ 'positive' if mes.variacao > 0 else 'negative' if mes.variacao < 0 else 'neutral' }}">
                                        {{ mes.variacao_text }}
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="no-data">
                                <p>Dados de comparativo n√£o dispon√≠veis</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </section>
</article>

<!-- Modal para Detalhes do Grupo -->
<div id="grupo-details-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>üìä Detalhes do Grupo</h3>
            <span class="modal-close">&times;</span>
        </div>
        <div class="modal-body">
            <div id="grupo-details-content">
                <!-- Conte√∫do ser√° preenchido via JavaScript -->
            </div>
        </div>
        <div class="modal-footer">
            <button class="modal-btn primary" onclick="exportGrupoDetailed()">üìä Exportar Detalhado</button>
            <button class="modal-btn secondary" onclick="closeModal()">‚ùå Fechar</button>
        </div>
    </div>
</div>

<style>
.perdaporgrupo-page {
    max-width: 1800px;
    margin: 0 auto;
    padding: 20px;
}

.header-container {
    text-align: center;
    margin-bottom: 30px;
}

.page-title h2 {
    color: #3498db;
    font-size: 2.5rem;
    margin-bottom: 10px;
}

.page-subtitle {
    color: #7f8c8d;
    font-size: 1.1rem;
    margin-bottom: 20px;
}

.breadcrumb-nav {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 10px;
    margin-top: 15px;
}

.breadcrumb-link {
    color: #3498db;
    text-decoration: none;
    padding: 5px 10px;
    border-radius: 5px;
    transition: background-color 0.3s;
}

.breadcrumb-link:hover {
    background-color: #ecf0f1;
}

.breadcrumb-separator {
    color: #bdc3c7;
}

.breadcrumb-current {
    color: #2c3e50;
    font-weight: bold;
}

.summary-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 20px;
    margin-bottom: 40px;
}

.summary-card {
    background: white;
    border-radius: 12px;
    padding: 25px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    display: flex;
    align-items: center;
    gap: 20px;
}

.summary-card.total-grupos {
    border-left: 5px solid #3498db;
}

.summary-card.valor-total {
    border-left: 5px solid #e74c3c;
}

.summary-card.grupo-maior {
    border-left: 5px solid #f39c12;
}

.summary-card.periodo-analise {
    border-left: 5px solid #27ae60;
}

.summary-icon {
    font-size: 3rem;
    opacity: 0.8;
}

.summary-content h3 {
    color: #2c3e50;
    margin-bottom: 10px;
    font-size: 1.2rem;
}

.summary-value {
    font-size: 1.8rem;
    font-weight: bold;
    color: #2c3e50;
    margin: 0;
}

.summary-label {
    color: #7f8c8d;
    font-size: 0.9rem;
}

.filters-container {
    background: white;
    border-radius: 12px;
    padding: 25px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    margin-bottom: 30px;
    display: flex;
    flex-wrap: wrap;
    gap: 20px;
    align-items: end;
    justify-content: flex-end;
}

.filter-group {
    display: flex;
    flex-direction: row;
    align-items: center;
    gap: 8px;
    min-width: 150px;
}

.filter-group label {
    color: #2c3e50;
    font-weight: 500;
    font-size: 0.9rem;
    white-space: nowrap;
    flex-shrink: 0;
}

.filter-select, .filter-input {
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 6px;
    font-size: 0.9rem;
    background: white;
}

.filter-select:focus, .filter-input:focus {
    outline: none;
    border-color: #3498db;
    box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
}

.filter-button {
    padding: 10px 20px;
    border: none;
    border-radius: 6px;
    font-size: 0.9rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s;
    background: #3498db;
    color: white;
}

.filter-button:hover {
    background: #2980b9;
    transform: translateY(-1px);
}

.filter-button.secondary {
    background: #95a5a6;
}

.filter-button.secondary:hover {
    background: #7f8c8d;
}

.filter-button.success {
    background: #27ae60;
}

.filter-button.success:hover {
    background: #229954;
}

.grid-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 25px;
    margin-bottom: 40px;
}

.grupo-box {
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    overflow: hidden;
    transition: all 0.3s;
}

.grupo-box:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 15px rgba(0, 0, 0, 0.15);
}

.grupo-header {
    background: #f8f9fa;
    padding: 20px;
    border-bottom: 1px solid #dee2e6;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.grupo-title h3 {
    color: #2c3e50;
    margin: 0;
    font-size: 1.3rem;
}

.grupo-codigo {
    color: #7f8c8d;
    font-size: 0.9rem;
    background: #ecf0f1;
    padding: 4px 8px;
    border-radius: 4px;
    margin-left: 10px;
}

.grupo-actions {
    display: flex;
    gap: 8px;
}

.grupo-btn {
    padding: 8px 12px;
    border: none;
    border-radius: 6px;
    background: #ecf0f1;
    color: #2c3e50;
    cursor: pointer;
    transition: all 0.3s;
    font-size: 0.9rem;
}

.grupo-btn:hover {
    background: #bdc3c7;
    transform: translateY(-1px);
}

.grupo-summary {
    padding: 20px;
}

.summary-stats {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 15px;
    margin-bottom: 20px;
}

.stat-item {
    text-align: center;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 8px;
}

.stat-label {
    display: block;
    color: #7f8c8d;
    font-size: 0.85rem;
    margin-bottom: 5px;
}

.stat-value {
    display: block;
    color: #2c3e50;
    font-size: 1.2rem;
    font-weight: bold;
}

.grupo-chart {
    margin-top: 15px;
}

.chart-bar {
    background: #ecf0f1;
    border-radius: 10px;
    height: 20px;
    position: relative;
    overflow: hidden;
}

.bar-fill {
    background: linear-gradient(90deg, #3498db, #2980b9);
    height: 100%;
    transition: width 0.3s ease;
    border-radius: 10px;
}

.bar-percentage {
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    color: #2c3e50;
    font-size: 0.8rem;
    font-weight: bold;
}

.grupo-content {
    border-top: 1px solid #dee2e6;
}

.content-tabs {
    display: flex;
    background: #f8f9fa;
}

.tab-btn {
    flex: 1;
    padding: 15px;
    border: none;
    background: transparent;
    color: #7f8c8d;
    cursor: pointer;
    transition: all 0.3s;
    border-bottom: 3px solid transparent;
}

.tab-btn.active {
    color: #3498db;
    border-bottom-color: #3498db;
    background: white;
}

.tab-btn:hover {
    color: #2c3e50;
    background: #ecf0f1;
}

.tab-content {
    padding: 25px;
}

.eventos-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 15px;
}

.evento-item {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 15px;
    border-left: 4px solid #3498db;
}

.evento-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
}

.evento-code {
    background: #3498db;
    color: white;
    padding: 4px 8px;
    border-radius: 4px;
    font-weight: bold;
    font-size: 0.85rem;
}

.evento-count {
    color: #7f8c8d;
    font-size: 0.8rem;
}

.evento-body {
    margin-bottom: 15px;
}

.evento-valor {
    font-size: 1.1rem;
    font-weight: bold;
    color: #e74c3c;
    margin-bottom: 5px;
}

.evento-descricao {
    color: #7f8c8d;
    font-size: 0.85rem;
}

.evento-actions {
    text-align: center;
}

.evento-btn {
    padding: 6px 12px;
    border: none;
    border-radius: 4px;
    background: #3498db;
    color: white;
    cursor: pointer;
    transition: all 0.3s;
    font-size: 0.8rem;
}

.evento-btn:hover {
    background: #2980b9;
    transform: translateY(-1px);
}

.produtos-table {
    max-height: 300px;
    overflow: auto;
}

.produtos-table-content {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.9rem;
}

.produtos-table-content th {
    background: #f8f9fa;
    color: #2c3e50;
    padding: 12px 8px;
    text-align: left;
    border-bottom: 2px solid #dee2e6;
    position: sticky;
    top: 0;
    z-index: 10;
}

.produtos-table-content td {
    padding: 10px 8px;
    border-bottom: 1px solid #dee2e6;
}

.produtos-table-content tr:hover {
    background-color: #f8f9fa;
}

.mercadoria {
    font-weight: 500;
    color: #2c3e50;
}

.descricao {
    max-width: 200px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.valor {
    font-weight: bold;
    color: #e74c3c;
    text-align: right;
}

.quantidade {
    text-align: center;
    font-weight: 500;
}

.actions {
    display: flex;
    gap: 5px;
    justify-content: center;
}

.action-btn {
    padding: 6px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.3s;
    font-size: 0.8rem;
    background: #ecf0f1;
}

.action-btn:hover {
    transform: scale(1.1);
    background: #bdc3c7;
}

.timeline-container {
    display: flex;
    flex-direction: column;
    gap: 15px;
    max-height: 300px;
    overflow-y: auto;
}

.timeline-item {
    display: flex;
    gap: 15px;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 8px;
    border-left: 3px solid #3498db;
}

.timeline-marker {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: #3498db;
    margin-top: 5px;
    flex-shrink: 0;
}

.timeline-content {
    flex: 1;
}

.timeline-date {
    color: #7f8c8d;
    font-size: 0.85rem;
    margin-bottom: 5px;
}

.timeline-event {
    color: #2c3e50;
    font-weight: 500;
    margin-bottom: 5px;
}

.timeline-value {
    color: #e74c3c;
    font-weight: bold;
}

.no-groups {
    grid-column: 1 / -1;
    text-align: center;
    color: #7f8c8d;
    padding: 80px 20px;
}

.no-groups-icon {
    font-size: 5rem;
    margin-bottom: 20px;
    opacity: 0.5;
}

.no-groups h3 {
    font-size: 1.5rem;
    margin-bottom: 10px;
}

.no-groups p {
    font-size: 1.1rem;
    margin-bottom: 20px;
}

.refresh-btn {
    padding: 12px 24px;
    border: none;
    border-radius: 6px;
    background: #3498db;
    color: white;
    cursor: pointer;
    transition: all 0.3s;
    font-size: 1rem;
    font-weight: 500;
}

.refresh-btn:hover {
    background: #2980b9;
    transform: translateY(-1px);
}

.analytics-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 25px;
}

.analytics-card {
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    overflow: hidden;
}

.card-header {
    background: #f8f9fa;
    padding: 20px;
    border-bottom: 1px solid #dee2e6;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.card-header h3 {
    color: #2c3e50;
    margin: 0;
    font-size: 1.2rem;
}

.card-actions {
    display: flex;
    gap: 10px;
}

.card-btn {
    padding: 8px 12px;
    border: none;
    border-radius: 6px;
    background: #ecf0f1;
    color: #2c3e50;
    cursor: pointer;
    transition: all 0.3s;
    font-size: 0.9rem;
}

.card-btn:hover {
    background: #bdc3c7;
    transform: translateY(-1px);
}

.card-content {
    padding: 25px;
}

.ranking-list {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.ranking-item {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 8px;
}

.ranking-position {
    background: #3498db;
    color: white;
    width: 30px;
    height: 30px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 0.9rem;
}

.ranking-info {
    flex: 1;
}

.ranking-name {
    color: #2c3e50;
    font-weight: 500;
    margin-bottom: 5px;
}

.ranking-details {
    color: #7f8c8d;
    font-size: 0.85rem;
}

.ranking-value {
    color: #e74c3c;
    font-weight: bold;
    font-size: 1.1rem;
}

.ranking-percentage {
    color: #7f8c8d;
    font-size: 0.9rem;
    min-width: 50px;
    text-align: right;
}

.distribuicao-chart {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.distribuicao-item {
    display: flex;
    align-items: center;
    gap: 15px;
}

.distribuicao-label {
    color: #2c3e50;
    font-weight: 500;
    min-width: 100px;
    font-size: 0.9rem;
}

.distribuicao-bar {
    flex: 1;
    background: #ecf0f1;
    border-radius: 4px;
    height: 25px;
    position: relative;
    overflow: hidden;
}

.distribuicao-bar .bar-fill {
    background: linear-gradient(90deg, #3498db, #2980b9);
    height: 100%;
    transition: width 0.3s ease;
}

.distribuicao-bar .bar-value {
    position: absolute;
    right: 8px;
    top: 50%;
    transform: translateY(-50%);
    color: #2c3e50;
    font-size: 0.8rem;
    font-weight: bold;
}

.distribuicao-percentage {
    color: #7f8c8d;
    font-size: 0.85rem;
    min-width: 50px;
    text-align: right;
}

.comparativo-chart {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.comparativo-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 8px;
}

.comparativo-mes {
    color: #2c3e50;
    font-weight: 500;
    font-size: 0.95rem;
}

.comparativo-valores {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 5px;
}

.valor-atual {
    color: #2c3e50;
    font-weight: bold;
    font-size: 1.1rem;
}

.valor-anterior {
    color: #7f8c8d;
    font-size: 0.85rem;
}

.valor-variacao {
    font-size: 0.8rem;
    font-weight: 500;
    padding: 2px 6px;
    border-radius: 4px;
}

.valor-variacao.positive {
    background: #d5f4e6;
    color: #27ae60;
}

.valor-variacao.negative {
    background: #fadbd8;
    color: #e74c3c;
}

.valor-variacao.neutral {
    background: #f8f9fa;
    color: #7f8c8d;
}

.no-data {
    text-align: center;
    color: #7f8c8d;
    padding: 40px 20px;
}

.no-data p {
    font-size: 1rem;
    margin: 0;
}

/* Modal Styles */
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
}

.modal-content {
    background-color: white;
    margin: 5% auto;
    padding: 0;
    border-radius: 12px;
    width: 90%;
    max-width: 800px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
}

.modal-header {
    background: #f8f9fa;
    padding: 20px;
    border-bottom: 1px solid #dee2e6;
    border-radius: 12px 12px 0 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-header h3 {
    color: #2c3e50;
    margin: 0;
}

.modal-close {
    font-size: 1.5rem;
    cursor: pointer;
    color: #7f8c8d;
}

.modal-close:hover {
    color: #2c3e50;
}

.modal-body {
    padding: 25px;
    max-height: 60vh;
    overflow-y: auto;
}

.modal-footer {
    background: #f8f9fa;
    padding: 20px;
    border-top: 1px solid #dee2e6;
    border-radius: 0 0 12px 12px;
    display: flex;
    justify-content: flex-end;
    gap: 15px;
}

.modal-btn {
    padding: 10px 20px;
    border: none;
    border-radius: 6px;
    font-size: 0.9rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s;
}

.modal-btn.primary {
    background: #3498db;
    color: white;
}

.modal-btn.primary:hover {
    background: #2980b9;
}

.modal-btn.secondary {
    background: #95a5a6;
    color: white;
}

.modal-btn.secondary:hover {
    background: #7f8c8d;
}

@media (max-width: 768px) {
    .grid-container {
        grid-template-columns: 1fr;
    }
    
    .summary-container {
        grid-template-columns: 1fr;
    }
    
    .analytics-container {
        grid-template-columns: 1fr;
    }
    
    .filters-container {
        flex-direction: column;
        align-items: stretch;
    }
    
    .filter-group {
        min-width: auto;
    }
    
    .summary-stats {
        grid-template-columns: 1fr;
    }
    
    .grupo-header {
        flex-direction: column;
        align-items: stretch;
        gap: 15px;
    }
    
    .grupo-actions {
        justify-content: center;
    }
    
    .content-tabs {
        flex-direction: column;
    }
    
    .eventos-grid {
        grid-template-columns: 1fr;
    }
    
    .page-title h2 {
        font-size: 2rem;
    }
    
    .breadcrumb-nav {
        flex-wrap: wrap;
    }
    
    .produtos-table-content {
        font-size: 0.8rem;
    }
    
    .produtos-table-content th,
    .produtos-table-content td {
        padding: 8px 4px;
    }
    
    .descricao {
        max-width: 120px;
    }
    
    .ranking-item {
        flex-direction: column;
        align-items: stretch;
        text-align: center;
        gap: 10px;
    }
    
    .comparativo-item {
        flex-direction: column;
        align-items: stretch;
        text-align: center;
        gap: 10px;
    }
    
    .modal-content {
        width: 95%;
        margin: 10% auto;
    }
    
    .modal-footer {
        flex-direction: column;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Aplicar filtros
    const applyFiltersBtn = document.getElementById('apply-filters');
    const clearFiltersBtn = document.getElementById('clear-filters');
    const exportGroupsBtn = document.getElementById('export-groups');
    
    if (applyFiltersBtn) {
        applyFiltersBtn.addEventListener('click', applyFilters);
    }
    
    if (clearFiltersBtn) {
        clearFiltersBtn.addEventListener('click', clearFilters);
    }
    
    if (exportGroupsBtn) {
        exportGroupsBtn.addEventListener('click', exportGroups);
    }
    
    // Modal
    const modal = document.getElementById('grupo-details-modal');
    const closeBtn = document.querySelector('.modal-close');
    
    if (closeBtn) {
        closeBtn.addEventListener('click', closeModal);
    }
    
    if (modal) {
        window.addEventListener('click', function(event) {
            if (event.target === modal) {
                closeModal();
            }
        });
    }
    
    // Animar barras de progresso
    const bars = document.querySelectorAll('.bar-fill');
    bars.forEach(bar => {
        const width = bar.style.width;
        bar.style.width = '0%';
        setTimeout(() => {
            bar.style.width = width;
        }, 500);
    });
});

function toggleGrupo(grupoId) {
    const content = document.getElementById(`content-${grupoId}`);
    const button = event.target;
    
    if (content.style.display === 'none' || content.style.display === '') {
        content.style.display = 'block';
        button.textContent = 'üìã';
    } else {
        content.style.display = 'none';
        button.textContent = 'üìã';
    }
}

function showGrupoDetails(grupoId) {
    const modal = document.getElementById('grupo-details-modal');
    const content = document.getElementById('grupo-details-content');
    
    // Simular carregamento de detalhes
    content.innerHTML = `
        <div class="loading">Carregando detalhes do grupo ${grupoId}...</div>
    `;
    
    modal.style.display = 'block';
    
    // Simular dados carregados
    setTimeout(() => {
        content.innerHTML = `
            <div class="detail-section">
                <h4>Informa√ß√µes Gerais</h4>
                <div class="detail-grid">
                    <div class="detail-item">
                        <strong>C√≥digo:</strong> ${grupoId}
                    </div>
                    <div class="detail-item">
                        <strong>Total de Itens:</strong> 45
                    </div>
                    <div class="detail-item">
                        <strong>Valor Total:</strong> R$ 15.750,00
                    </div>
                    <div class="detail-item">
                        <strong>√öltima Atualiza√ß√£o:</strong> ${new Date().toLocaleDateString()}
                    </div>
                </div>
            </div>
            
            <div class="detail-section">
                <h4>Top 5 Produtos</h4>
                <div class="top-produtos">
                    <div class="produto-item">
                        <span class="produto-nome">Produto A</span>
                        <span class="produto-valor">R$ 2.500,00</span>
                    </div>
                    <div class="produto-item">
                        <span class="produto-nome">Produto B</span>
                        <span class="produto-valor">R$ 2.100,00</span>
                    </div>
                    <div class="produto-item">
                        <span class="produto-nome">Produto C</span>
                        <span class="produto-valor">R$ 1.800,00</span>
                    </div>
                </div>
            </div>
        `;
    }, 1000);
}

function exportGrupo(grupoId) {
    showNotification(`Exportando dados do grupo ${grupoId}...`, 'info');
}

function showTab(grupoId, tabName) {
    // Esconder todas as tabs
    const tabs = document.querySelectorAll(`#content-${grupoId} .tab-content`);
    tabs.forEach(tab => tab.style.display = 'none');
    
    // Remover classe active de todos os bot√µes
    const buttons = document.querySelectorAll(`#content-${grupoId} .tab-btn`);
    buttons.forEach(btn => btn.classList.remove('active'));
    
    // Mostrar tab selecionada
    const selectedTab = document.getElementById(`tab-${tabName}-${grupoId}`);
    if (selectedTab) {
        selectedTab.style.display = 'block';
    }
    
    // Adicionar classe active ao bot√£o clicado
    event.target.classList.add('active');
}

function analyzeEvento(grupoId, eventoId) {
    showNotification(`Analisando evento ${eventoId} do grupo ${grupoId}...`, 'info');
}

function analyzeProduto(grupoId, produtoId) {
    showNotification(`Analisando produto ${produtoId} do grupo ${grupoId}...`, 'info');
}

function adjustProduto(grupoId, produtoId) {
    if (confirm(`Confirma o ajuste do produto ${produtoId}?`)) {
        showNotification(`Ajustando produto ${produtoId}...`, 'success');
    }
}

function applyFilters() {
    const grupoFilter = document.getElementById('filter-grupo').value;
    const valorMin = parseFloat(document.getElementById('filter-valor-min').value) || 0;
    const valorMax = parseFloat(document.getElementById('filter-valor-max').value) || Infinity;
    const ordenacao = document.getElementById('filter-ordenacao').value;
    
    const grupos = document.querySelectorAll('.grupo-box');
    let visibleCount = 0;
    
    grupos.forEach(grupo => {
        const grupoCode = grupo.dataset.grupo;
        const grupoValor = parseFloat(grupo.dataset.valor.replace(/[^\d.-]/g, '')) || 0;
        
        const grupoMatch = grupoFilter === 'all' || grupoCode === grupoFilter;
        const valorMatch = grupoValor >= valorMin && grupoValor <= valorMax;
        
        if (grupoMatch && valorMatch) {
            grupo.style.display = '';
            visibleCount++;
        } else {
            grupo.style.display = 'none';
        }
    });
    
    // Aplicar ordena√ß√£o
    applyOrdering(ordenacao);
    
    showNotification(`Filtros aplicados. ${visibleCount} grupos encontrados.`, 'info');
}

function clearFilters() {
    document.getElementById('filter-grupo').value = 'all';
    document.getElementById('filter-valor-min').value = '';
    document.getElementById('filter-valor-max').value = '';
    document.getElementById('filter-ordenacao').value = 'valor-desc';
    
    const grupos = document.querySelectorAll('.grupo-box');
    grupos.forEach(grupo => {
        grupo.style.display = '';
    });
    
    showNotification('Filtros limpos', 'info');
}

function applyOrdering(ordenacao) {
    const container = document.getElementById('grupos-grid');
    const grupos = Array.from(container.querySelectorAll('.grupo-box'));
    
    grupos.sort((a, b) => {
        const aValor = parseFloat(a.dataset.valor.replace(/[^\d.-]/g, '')) || 0;
        const bValor = parseFloat(b.dataset.valor.replace(/[^\d.-]/g, '')) || 0;
        const aNome = a.dataset.nome || '';
        const bNome = b.dataset.nome || '';
        
        switch (ordenacao) {
            case 'valor-desc':
                return bValor - aValor;
            case 'valor-asc':
                return aValor - bValor;
            case 'nome-asc':
                return aNome.localeCompare(bNome);
            case 'nome-desc':
                return bNome.localeCompare(aNome);
            default:
                return bValor - aValor;
        }
    });
    
    // Reordenar elementos no DOM
    grupos.forEach(grupo => container.appendChild(grupo));
}

function exportGroups() {
    showNotification('Exportando dados de todos os grupos...', 'info');
}

function refreshRanking() {
    showNotification('Atualizando ranking...', 'info');
}

function exportRanking() {
    showNotification('Exportando ranking...', 'info');
}

function refreshDistribuicao() {
    showNotification('Atualizando distribui√ß√£o...', 'info');
}

function exportDistribuicao() {
    showNotification('Exportando distribui√ß√£o...', 'info');
}

function refreshComparativo() {
    showNotification('Atualizando comparativo...', 'info');
}

function exportComparativo() {
    showNotification('Exportando comparativo...', 'info');
}

function closeModal() {
    const modal = document.getElementById('grupo-details-modal');
    modal.style.display = 'none';
}

function exportGrupoDetailed() {
    showNotification('Exportando detalhes do grupo...', 'info');
    closeModal();
}

function showNotification(message, type = 'info') {
    // Criar notifica√ß√£o tempor√°ria
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.textContent = message;
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 20px;
        border-radius: 6px;
        color: white;
        font-weight: 500;
        z-index: 1001;
        opacity: 0;
        transform: translateX(100%);
        transition: all 0.3s ease;
    `;
    
    // Definir cor baseada no tipo
    switch (type) {
        case 'success':
            notification.style.backgroundColor = '#27ae60';
            break;
        case 'error':
            notification.style.backgroundColor = '#e74c3c';
            break;
        case 'warning':
            notification.style.backgroundColor = '#f39c12';
            break;
        default:
            notification.style.backgroundColor = '#3498db';
    }
    
    document.body.appendChild(notification);
    
    // Animar entrada
    setTimeout(() => {
        notification.style.opacity = '1';
        notification.style.transform = 'translateX(0)';
    }, 100);
    
    // Remover ap√≥s 3 segundos
    setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => {
            document.body.removeChild(notification);
        }, 300);
    }, 3000);
}
</script>
{% endblock %}